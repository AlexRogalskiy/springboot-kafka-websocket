= `springboot-kafka-websocket`

The goal of this project is to implement two micro-services: 1) `bitcoin-api`: responsible simulate the `BTC` price
changes and push those price changes to `Kafka` and 2) `bitcoin-client`: service that reads from `Kafka` and updates
its UI using `Websocket`.

* We are using https://docs.spring.io/spring-cloud-stream/docs/current/reference/htmlsingle[Spring Cloud Stream]
framework for building highly scalable event-driven microservices connected with shared messaging systems.

* We are using https://www.thymeleaf.org/[Thymeleaf] as HTML template

* We are using https://zipkin.io[Zipkin] for visualizing traces between and within microservices.

* We are using https://github.com/Landoop/kafka-topics-ui[Kafka Topics UI] for visualizing the messages on Kafka topics.

== Build Docker Images

In a terminal and inside `springboot-kafka-websocket` root folder, run the following `./mvnw` commands to build the
microservices docker images

=== bitcoin-api

```
./mvnw clean package dockerfile:build -DskipTests --projects bitcoin-api
```
|===
|Environment Variable | Description

|`MYSQL_HOST`
|Specify host of the `MySQL` database to use (default `localhost`)

|`MYSQL_PORT`
|Specify port of the `MySQL` database to use (default `3306`)

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `29092`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

=== bitcoin-client

```
./mvnw clean package dockerfile:build -DskipTests --projects bitcoin-client
```
|===
|Environment Variable | Description

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `9092`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

== Start Environment

In a terminal and inside `springboot-kafka-websocket` root folder run
```
docker-compose up -d
```

Wait a little bit until all containers are Up (healthy). You can check their status running
```
docker-compose ps
```

== Microservice Links

|===
|Microservice |URL

|`bitcoin-api`
|http://localhost:9081/swagger-ui.html

|`bitcoin-client`
|http://localhost:9082

|===

The gif below shows two users checking real-time the BTC price changes. Besides, they are using a chat channel to
communicate with each other.

image::./images/two-users-example.gif[]

== Running microservices with Maven

During development, it is better to just run the microservices with Maven instead of always build the docker images and
run it. In order to do that, comment the `bitcoin-api` and/or `bitcoin-client` in `docker-compose.yml` file and run the
microservice(s) with Maven Wrapper.

=== bitcoin-api

```
./mvnw spring-boot:run --projects bitcoin-api -Dspring-boot.run.jvmArguments="-Dserver.port=9081"
```

=== bitcoin-client

```
./mvnw spring-boot:run --projects bitcoin-client -Dspring-boot.run.jvmArguments="-Dserver.port=9082"
```

== Shutdown

Run the command below to stop and remove containers, networks and volumes
```
docker-compose down -v
```

== Useful Links & Commands

=== Zipkin

`Zipkin` can be accessed at http://localhost:9411

=== Kafka Topics UI

`Kafka Topics UI` can be accessed at http://localhost:8085

=== Kafka Manager

`Kafka Manager` can be accessed at http://localhost:9000

**Configuration**

- First, you must create a new cluster. Click on `Cluster` (dropdown on the header) and then on `Add Cluster`
- Type the name of your cluster in `Cluster Name` field, for example: `MyZooCluster`
- Type `zookeeper:2181` in `Cluster Zookeeper Hosts` field
- Enable checkbox `Poll consumer information (Not recommended for large # of consumers if ZK is used for offsets tracking on older Kafka versions)`
- Click on `Save` button at the bottom of the page.

=== MySQL
```
docker exec -it bitcoin-mysql mysql -uroot -psecret --database=bitcoindb
select * from prices;
```
